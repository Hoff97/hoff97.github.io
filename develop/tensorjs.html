
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="index, follow" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://hoff97.github.io/develop/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://hoff97.github.io/develop/theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="https://hoff97.github.io/develop/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://hoff97.github.io/develop/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://hoff97.github.io/develop/theme/font-awesome/css/solid.css">


    <link href="https://hoff97.github.io/develop/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="haskai Atom">


    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

  

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Microsoft EDGE -->
    <meta name="msapplication-TileColor" content="#333">

 

<meta name="author" content="Frithjof Winkelmann" />
<meta name="description" content="During the lockdown in spring of 2021 I wrote a deep learning library for the web. Here&#39;s what I learned." />
<meta name="keywords" content="deep-learning, javascript">


  <meta property="og:site_name" content="haskai"/>
  <meta property="og:title" content="TensorJS - Writing a fast deep learning library for the browser"/>
  <meta property="og:description" content="During the lockdown in spring of 2021 I wrote a deep learning library for the web. Here&#39;s what I learned."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://hoff97.github.io/develop/tensorjs.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2021-09-16 12:09:00+02:00"/>
  <meta property="article:modified_time" content="2021-09-16 12:09:00+02:00"/>
  <meta property="article:author" content="https://hoff97.github.io/develop/author/frithjof-winkelmann.html">
  <meta property="article:section" content="Machine learning"/>
  <meta property="article:tag" content="deep-learning"/>
  <meta property="article:tag" content="javascript"/>
  <meta property="og:image" content="/images/profile.png">

  <title>haskai &ndash; TensorJS - Writing a fast deep learning library for the browser</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="https://hoff97.github.io/develop/">
        <img src="/images/profile.png" alt="Frithjof Winkelmann" title="Frithjof Winkelmann">
      </a>

      <h1>
        <a href="https://hoff97.github.io/develop/">Frithjof Winkelmann</a>
      </h1>

<p>Software Developer</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="https://hoff97.github.io/develop/pages/about.html#about">
                  About
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/Hoff97" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/frithjof-winkelmann-338a99a8/" target="_blank">
              <i class="fab fa-linkedin"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="https://hoff97.github.io/develop/">Home</a>

      <a href="/categories">Categories</a>
      <a href="/tags">Tags</a>

      <a href="https://hoff97.github.io/develop/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="tensorjs">TensorJS - Writing a fast deep learning library for the browser</h1>
    <p>
      Posted on Thu 16 September 2021 in <a href="https://hoff97.github.io/develop/category/machine-learning.html">Machine learning</a>

    </p>
  </header>


  <div>
    <p>When I build <a href="https://detext.haskai.de/client/">Detext</a>, I was looking for deep learning libraries for the browser.
The main 2 options where</p>
<ul>
<li><a href="https://github.com/microsoft/onnxjs">Onnx.JS</a>, developed by Microsoft but not actively maintained at the time</li>
<li><a href="https://www.tensorflow.org/js">TensorFlow.js</a>, which is pretty mature and well maintained by facebook, but uses its own storage format for
  trained networks. Converting a trained Pytorch model to this format proved to be very challenging at the time.</li>
</ul>
<p>So, what do you do when there's no viable inference library for executing your
PyTorch/ONNX model? You write your own library of course.
The requirements that I had for this library specifically where:</p>
<ul>
<li>Fast execution of reasonably sized models on most hardware and browsers. For me, reasonably
  sized meant a MobileNet on the harware that I had access to - a pretty shitty
  laptop and a Okish mobile phone.</li>
<li>A "low level" PyTorch like interface for doing computations with tensors - eg.
  being able to do something like
    <code>const a = new Tensor([1,2,3,4,5,6], {shape: [2,3]}); const b = new Tensor([1,2,3,4,5,6], {shape: [3,2]}); a.matmul(b);</code>
  I wanted to have this, so that the pre- and postprocessing that most models
  typically need could be done as fast as executing the model itself.</li>
<li>A "high level" interface for executing models stored in the ONNX format.</li>
</ul>
<h1>Tensors and how they are layed out in memory</h1>
<p>Deep learning frameworks are centered around the concept of a tensor - which to us computer programmers is
basically a multidimensional array. Consider a multi dimensional array/tensor like the following one:</p>
<div class="highlight"><pre><span></span>[[[1,2,3,4],
  [5,6,7,8],
  [9,10,11,12]],

 [[13,14,15,16],
  [17,18,19,20],
  [21,22,23,24]]]
</pre></div>


<p>This tensor has 3 dimensions, which we call its "rank". The dimensions have a length of
<code>[2,3,4]</code> respectively, which we summarize as the tensors shape. The simplest layout
to store tensors in memory is called the contiguous layout - which basically
just stores the values in the order that you specify them, together with the shape of the tensor.</p>
<p>This layout allows you to have zero-copy reshapes of tensors, but not much else.
While there is also the strided layout that allows you to have zero copy
transpose and range selection operations, I chose to go with the contiguous layout,
since its easy to implement.</p>
<h1>Execution backends on the Web</h1>
<p>While tensor operations are very straightforward to implement in Javascript, these implementations
will not be fast enough to execute any reasonably sized model.
Luckily there are other options for fast code execution:</p>
<ul>
<li><a href="https://webassembly.org/">Webassembly</a>, a binary instruction format that can give you faster runtime than simple 
  Javascript - if optimized sufficiently.</li>
<li><a href="https://en.wikipedia.org/wiki/WebGL">WebGL</a>, a Javascript API intended for 2D and 3D rendering.</li>
</ul>
<h2>Webassembly</h2>
<p>Webassembly (WASM) by now is supported by all major browsers. While you can in principle handwrite Webassembly
in the <a href="https://developer.mozilla.org/en-US/docs/WebAssembly/Understanding_the_text_format">WAT format</a>,
I chose to use Rust. Compiling to WASM is pretty well supported and
<a href="https://github.com/rustwasm/wasm-bindgen">wasm-bindgen</a> even generates the JS boilerplate code
for calling into WASM, and corresponding Typescript Type definitions for you.
With this writing the WASM backend was way simpler than expected.</p>
<h2>WebGL</h2>
<p>WebGL was originally intended for 2D and 3D visualizations accelerated by GPUs.
So how do you abuse this API to implement fast tensor operations?</p>
<p>The traditional pipeline in WebGL looks a bit like this:</p>
<p><img alt="WebGL standard pipeline" src="{filename}/../images/tensorjs/webgl_standard.png"></p>
<p>You feed the geometry of the scene and textures to the vertex and fragment shaders.
The vertex shader determines the position of all vertices on the screen, while
the fragment shader determines the color of each pixel on the screen - typically
using the textures.</p>
<p>By setting up a very simple scene geometry of a single rectengular plane
that fills up the whole screen, you can use the textures as
your input tensors and treat the rendered output as the result tensor.</p>
<p><img alt="WebGL for GPGPU" src="{filename}/../images/tensorjs/webgl_gpgpu.png"></p>
<p>Doing this allows you to implement many operations by simply writing the correct
fragment shader.</p>
<p>There is one detail that I'm going over here - which is the conversion of tensors
to textures and back. For this you</p>
<ol>
<li>Represent the tensor in the contiguous layout</li>
<li>Create a texture of fitting height and width. If the tensor has a size that is not conveniently 
   dividable into integer width and height you create a texture that is slightly bigger than needed.</li>
<li>You fill the tensor data into the texture pixels row by row. Since each pixel consists of
   4 floating point values for the red, green, blue and transparent component, you only need
   1/4th of the pixels of the size of your tensor.</li>
</ol>
<p>In the fragment shader you of course also have to do this conversion between tensor indices
and texture coordinates.</p>
<h3>Considerations for fast speed</h3>
<p>TODO: talk about precompiling shaders, keeping all data on GPU</p>
<h1>Features of TensorJS</h1>
<h2>ONNX support</h2>
<p>TODO: List of supported operators</p>
<h2>Automatic differentiation</h2>
<p>TODO: Quickly talk about graph representation</p>
<h2>Optimizers and models</h2>
<p>TODO: How do optimizers discover model parameters</p>
<h2>Sparse tensors</h2>
<p>TODO: Short explanation of sparse tensors</p>
<h1>Example applications</h1>
<p>TODO: Mobilenet inference, style transfer, on device model finetuning</p>
<h1>Possible extensions</h1>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://hoff97.github.io/develop/tag/deep-learning.html">deep-learning</a>
      <a href="https://hoff97.github.io/develop/tag/javascript.html">javascript</a>
    </p>
  </div>

  <div class="center social-share">
    <p>Like this article? Share it with your friends!</p>
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
    <div class="addthis_inline_share_toolbox"></div>
  </div>


    <div class="addthis_relatedposts_inline"></div>


</article>

    <footer>
<p>
  &copy; 2020  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/deed.en_US" target="_blank">Creative Commons Attribution-ShareAlike</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by-sa/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>


    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-77hh6723hhjd" async="async"></script>


<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " haskai ",
  "url" : "https://hoff97.github.io/develop",
  "image": "/images/profile.png",
  "description": "Foo Bar's Thoughts and Writings"
}
</script>

</body>
</html>